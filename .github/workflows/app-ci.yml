name: App CI

on:
  push:
    branches:
      - main


permissions:
  id-token: write
  contents: read

jobs:
  ci-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show repo structure
        run: |
          echo "Current directory:"
          pwd
          echo
          echo "Repo files:"
          ls -R

  docker-build-and-push:
    runs-on: ubuntu-latest
    needs: ci-test

    env:
      AWS_REGION: eu-central-1
      ECR_ACCOUNT_ID: 154744860201
      ECR_REPO_NAME: eks-k8s-dev-app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::154744860201:role/terraform-eks-k8s-ecr-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" | docker login \
            --username AWS \
            --password-stdin "${ECR_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

      - name: Build and push Docker image to ECR (latest + commit SHA)
        working-directory: app/reactflow-app
        run: |
          ECR_BASE="${ECR_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"

          # RÃ¶vid commit SHA (pl. a1b2c3d4)
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-8)"

          IMAGE_LATEST="${ECR_BASE}:latest"
          IMAGE_SHA="${ECR_BASE}:${SHORT_SHA}"

          echo "Building images:"
          echo "  - $IMAGE_LATEST"
          echo "  - $IMAGE_SHA"

          docker build -t "$IMAGE_LATEST" -t "$IMAGE_SHA" .

          echo "Pushing images to ECR..."
          docker push "$IMAGE_LATEST"
          docker push "$IMAGE_SHA"

          echo "Pushed tags:"
          echo "  - latest"
          echo "  - ${SHORT_SHA}"
      - name: Update kubeconfig for EKS cluster
        run: |
          aws eks update-kubeconfig \
            --region "$AWS_REGION" \
            --name "eks-k8s-dev-cluster"

      - name: Update Deployment image and wait for rollout
        run: |
          ECR_BASE="${ECR_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-8)"
          IMAGE_SHA="${ECR_BASE}:${SHORT_SHA}"

          echo "Updating Deployment to image: $IMAGE_SHA"

          kubectl set image deployment/eks-k8s-dev-app \
            eks-k8s-dev-app="$IMAGE_SHA" \
            -n eks-k8s-dev-app

          echo "Waiting for rollout to complete..."
          kubectl rollout status deployment/eks-k8s-dev-app -n eks-k8s-dev-app

